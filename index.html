<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CubeGO Desktop</title>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.2.6/jquery.min.js"></script>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.5.2/jquery-ui.min.js"></script>
    <link rel="shortcut icon" href="images/cubego_logo_tab.png" type="image/x-icon">

<!--    <script src="https://www.WebRTC-Experiment.com/RecordRTC.js"></script>-->
    <script src="js/RecordRTC.js"></script>
    <script src="https://www.webrtc-experiment.com/EBML.js"></script>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1.24.min.js"></script>

    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jQuery-ui-Slider-Pips/1.11.4/jquery-ui-slider-pips.css" />
    <script src="https://code.jquery.com/jquery-3.3.1.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jQuery-ui-Slider-Pips/1.11.4/jquery-ui-slider-pips.js"></script>

    <script src="js/GazeCloudAPI.js"></script>
    <script src="js/index.js"></script>
    <script src="js/requests.js"></script>
    <script src="js/buttons.js"></script>
    <script src="js/Calibration.js"></script>


    <link rel="stylesheet" href="css/index.css">
</head>

<body>
<button id="GO-BACK" onclick="goBack()" translate key="GO-BACK">Go Back</button>


<div class="lang-menu">
    <div class="selected-lang">
        English
    </div>
    <ul class="lang-list">
        <li>
            <a class="en" onclick="return ToEnglish()">English</a>
        </li>
        <li>
            <a class="fr" onclick="return ToFrench()">French</a>
        </li>
    </ul>
</div>

<section id="StartPage">
    <div class="logo">
        <img src="images/cubelogo-2-black.png" alt="">
    </div>
    <h2 class="title" translate key="WELCOME">WELCOME</h2>
    <p class="text" translate key="to_start_a_test">To start a test, enter your email address and the test PIN</p>

    <form class="PINForm">
        <div class="input-field">
            <h4 translate key="Email">Email</h4>
            <label>
                <input name="email" id="StartPage-email" type="text" placeholder="EMAIL">
            </label>
        </div>

        <div class="input-field">
            <h4 translate key="TEST-PIN">Test PIN</h4>
            <label>
                <input name="token" type="text" id="StartPage-pin" placeholder="PIN" maxlength="4">
            </label>
        </div>
        <button id="StartPage-nextBtn" type="button" onclick="StartPageNextPage()" translate key="Start">Start</button>
    </form>
</section>

<section id="Agreement">
    <div class="important">
        <h2 translate key="IMPORTANT">IMPORTANT</h2>
    </div>

    <div class="content">
        <p translate key="you_will_now">You will now see instructions on how to prepare for the test.</p>
        <p translate key="payment_is_conditional">Payment is <b>conditional</b> upon following these instructions.</p>
        <p translate key="please_note_that">Please note that you will not have a second chance to submit a test.</p>
    </div>

    <div class="submit-section">
        <div class="checkbox">
            <input type="checkbox" id="Agreement-checkbox" onclick="AgreementCheckBox()"/>
            <label translate key="i_understand_that">I understand that I may not receive payment if I do not follow the next instructions.</label>
        </div>


        <button id="Agreement-nextBtn" disabled onclick="AgreementNextPage()" translate key="Start">Start</button>
    </div>
</section>

<section id="PreTestQuestion">
    <div class="title">
        <h2 translate key="please_answer_the">Please answer the question below</h2>
    </div>
    <div class="question">
        <p class="question-text"></p>
        <div class="radioGroup">
            <div class="radioButtons">
                <div class="wrap">
                    <label>0</label>
                    <input type="radio" name="rate" value="0" />
                </div>
                <div class="wrap">
                    <label>1</label>
                    <input type="radio" name="rate" value="1" />
                </div>
                <div class="wrap">
                    <label>2</label>
                    <input type="radio" name="rate" value="2" />
                </div>
                <div class="wrap">
                    <label>3</label>
                    <input type="radio" name="rate" value="3" />
                </div>
                <div class="wrap">
                    <label>4</label>
                    <input type="radio" name="rate" value="4" />
                </div>
                <div class="wrap">
                    <label>5</label>
                    <input type="radio" name="rate" value="5" />
                </div>
                <div class="wrap">
                    <label>6</label>
                    <input type="radio" name="rate" value="6" />
                </div>
                <div class="wrap">
                    <label>7</label>
                    <input type="radio" name="rate" value="7" />
                </div>
                <div class="wrap">
                    <label>8</label>
                    <input type="radio" name="rate" value="8" />
                </div>
                <div class="wrap">
                    <label>9</label>
                    <input type="radio" name="rate" value="9" />
                </div>
                <div class="wrap">
                    <label>10</label>
                    <input type="radio" name="rate" value="10" />
                </div>
            </div>
            <p class="left-text" translate key="extremely_unlikely">Extremely Unlikely</p>
            <p class="right-text" translate key="extremely_likely">Extremely Likely</p>
        </div>
    </div>

    <button id="PreTestQuestion-nextBtn" onclick="PreTestQuestionNextPage()" translate key="NEXT">Next</button>
</section>

<section id="PreCustomQuestions">
    <div class="title">
        <h2 translate key="custom_questions">Custom Questions</h2>
    </div>

    <button id="PreCustomQuestions-nextBtn" onclick="PreCustomQuestionsNextPage('PreCustomQuestions', 'Instruction1')" translate key="NEXT">Next</button>
</section>

<section id="Instruction1">
    <div class="progress"></div>
    <div class="title">
        <h2>1</h2>
        <h2 translate key="eliminate_distractions">Eliminate distractions</h2>
    </div>

    <div class="content">
        <p translate key="make_sure_that">Make sure that there are no noises in the room and that you will not be interrupted for the next 10-20 minutes.</p>
        <img src="images/instruction1.png" alt="">
    </div>

    <button id="Instruction1-nextBtn" onclick="gotoNextPage('Instruction1', 'Instruction2')" translate key="NEXT">NEXT</button>
</section>
<section id="Instruction2">
    <div class="progress"></div>
    <div class="title">
        <h2>2</h2>
        <h2 translate key="face_your_webcam">Face your webcam</h2>
    </div>

    <div class="content">
        <p translate key="make_sure_that_your">Make sure that your webcam is in front of you, and not to the side.</p>
        <img src="images/instruction2.png" alt="">
    </div>

    <button id="Instruction2-nextBtn" onclick="gotoNextPage('Instruction2', 'Instruction3')" translate key="NEXT">NEXT</button>
</section>
<section id="Instruction3">
    <div class="progress"></div>
    <div class="title">
        <h2>3</h2>
        <h2 translate key="close_other_open_tabs">Close other open tabs</h2>
    </div>

    <div class="content">
        <p translate key="close_any_other">Close any other open tabs in your browser window.</p>
        <img src="images/instruction3.png" alt="">
    </div>

    <button id="Instruction3-nextBtn" onclick="gotoNextPage('Instruction3', 'Instruction4')" translate key="NEXT">NEXT</button>
</section>

<section id="Instruction4">
    <div class="progress"></div>
    <div class="title">
        <h2>4</h2>
        <h2 translate key="start_the_recording">Start the recordings</h2>
    </div>

    <div class="content">
        <p translate key="when_youre_ready">When you’re ready, press ‘Start Recording’ and select <b>‘Entire Screen’ or ‘Application Window’</b></p>
        <img src="images/instruction4.png" alt="">
        <p translate key="by_clicking_start_recording">By Clicking "Start Recording" I agree to let CubeGO record my screen for the duration
            of this test. I understand CubeGO will use this information to understand how I am
            using this website, in order to improve this website's user experience.</p>
        <br>
        <p translate key="for_more_information">For more information on the use of the data collected, visit <a href="https://www.cubego.io/participants" target="_blank">CubeGO.io/participants</a></p>
    </div>

    <button id="Instruction4-nextBtn" translate key="start_recording">Start Recording</button>
</section>
<section id="Instruction5">
    <div class="progress"></div>
    <div class="title">
        <h2>5</h2>
        <h2 translate key="change_your_face">Change your face on the square</h2>
    </div>

    <div class="content">
        <div id="errid" style="height:100%; width:100%; left: 0px; position: fixed; top: 0%;display:none;opacity: 0.9; background-color: black;z-index: 99999;" >
            <h1 id="errmsgid" align="center" style="color: white;">Err</h1>
            <p align="center">
                <button class= "buttonRecalibrate" onclick=" GazeCloudAPI.RestartEyeTracking();"  type="button">Try again</button>
            </p>
        </div>

        <div id="loadid" style="height:100%; width:100%; left: 0px; position: fixed; top: 0%;display:none;opacity: 0.93; background-color: black;z-index: 9999;" >
            <h1 align="center" style="color: white;"> Loading...</h1>
            <div class="loader"></div>
        </div>

        <div id="waitslotid" style="height:100%; width:100%; left: 0px; position: fixed; top: 0%;display:none;opacity: 0.93; background-color: black;z-index: 9999;" >
            <h1 align="center" style="color: white;">Waiting for free slot...</h1>
            <h1 id = "waitslottimeid" align="center" style="color: white;">30</h1>
        </div>

        <div id="CalDivId" style="display: none; z-index: 999;background-color:white; position:fixed; left:0px; top:0px ;width: 100%; height: 100% " >
            <h1 id = "calinfoid"   style = " text-align: center; position: fixed;margin-left:auto; color:black; z-index: 999;top:25% ; width:100%" >Look at Dot</h1>
            <h1 id = "calinfoWaitid"   style = " text-align: center; position: fixed;margin-left:auto; color:black; z-index: 999;top:60% ; width:100%" >3</h1>
            <canvas id="CalCanvasId" style="background-color:white ;display: block;  left:0px; top:0px; width: 100%; height: 100%">
            </canvas>
        </div >

        <p translate key="make_sure_you_can">Make sure you can hold this position during the test.</p>
        <div id="camid">
            <canvas id="imagecanvas"></canvas>
            <video id ="showvideoid" autoplay></video>
            <img id="facecross" src="images/cross.png" alt="" key="cross">
            <div id="facemaskimgok"></div>
            <div id="facemaskimgno"></div>
            <div id="showinit" style="text-align: center; display: none">
                <br>
                <div>
                    <button class = "buttonCal" disabled id="_ButtonCalibrateId" type="button" onclick="GazeCloudAPI.ShowCalibration()">
                        <img src="https://api.gazerecorder.com/calibrate.png" width="40" height="40" >
                        <p style = " left:0%; top:0%; margin : 0"> Start Gaze Calibration </p>
                    </button>
                    <p id = "corectpositionid" style = " color: red;margin : 0; display:none"> Please, Corect your head position! </p>
                </div>
            </div >
        </div>
        <p translate key="by_clicking_next">By Clicking "Next" I agree to let CubeGO record my face for the duration of this test. I understand CubeGO will use this information to understand my eye-tracking and overall emotional response to this task</p>

        <canvas id="bgcanvas" width="640" height="480" style="display:none"></canvas>
        <div id="GazeFlowContainer" style=" background-color: white ;height:100%; width:100%; left: 0px; position: fixed; top: 0%;display:none;opacity: 1.0;z-index: 99;" > </div >
    </div>

    <button id="Instruction5-nextBtn" onclick="Instruction5NextPage()" translate key="NEXT">NEXT</button>
<!--    <button id="Instruction5-nextBtn" onclick="GazeCloudAPI.StartEyeTracking();" translate key="NEXT">NEXT</button>-->
</section>


<section id="calibration-video">
    <div class="title">
        <h2 translate key="please_follow_the">Please follow the circle with your eyes.</h2>
    </div>
    <svg height="8rem" width="8rem">
        <circle cx="4rem" cy="4rem" r="4rem" stroke="black" stroke-width="0" fill="yellow" />
    </svg>
    <button id="start-calibration" onclick="startCalibration()" translate key="start_calibration">Start Calibration</button>
</section>
<div id="calibration-circle"></div>


<section id="PreTask">
    <div class="title">
        <h2 translate key="almost_ready">Almost Ready!</h2>
    </div>

    <div class="content">
        <p translate key="you_will_now_complete">You will now complete a test on a different website.</p>
        <p translate key="the_webste_will">The website will open on a new tab.</p>
        <img src="images/preTask.png" alt="">
    </div>

<!--    <button id="PreTask-cameraPreview" onclick="OpenCameraPreview()">Click here to open camera preview</button>-->
<!--    <button id="PreTask-nextBtn" onclick="gotoNextPage('PreTask', 'Task')" translate key="NEXT">NEXT</button>-->
    <button id="PreTask-nextBtn" onclick="gotoNextPage('PreTask', 'second-calibration-video')" translate key="NEXT">NEXT</button>
</section>

<section id="second-calibration-video">
    <div class="title">
        <h2 translate key="please_follow_the">Please follow the circle with your eyes.</h2>
    </div>
    <canvas width="200" height="200" id="second-calibration-circle-canvas"></canvas>
    <button id="start-second-calibration" onclick="startSecondCalibration()" translate key="start_calibration">Start Calibration</button>
</section>

<script>
    var g_canvas = document.getElementById("second-calibration-circle-canvas");
    var g_context = g_canvas.getContext("2d");
    var dir = 1;
    g_context.strokeStyle = 'white';

    var g_radius = 10;

    function f_drawCircle() {
        g_context.fillStyle = "black";
        g_context.beginPath();
        g_context.arc(100, 100, g_radius, 0, 2 * Math.PI);
        g_context.fill();
    }

    function f_clearCanvas() {
        g_context.clearRect(0, 0, g_canvas.width, g_canvas.height);
        g_context.strokeRect(0, 0, g_canvas.width, g_canvas.height);
    }

    function f_varySize() {
        if (g_radius > 100) {
            dir = -1;
        }
        if (g_radius < 2) {
            dir = 1;
        }
        g_radius += dir;

    }

    function f_loop() {
        f_varySize();
        f_clearCanvas();
        f_drawCircle();
    }

    setInterval(f_loop, 20);
</script>

<div id="second-calibration-circle"></div>

<section id="Task">
    <div class="title">
        <h2 translate key="your_task">Your Task</h2>
    </div>

    <div class="content">
        <p translate key="once_on_the_website">Once on the website, please do the following: </p>
    </div>

    <div class="instructions">

    </div>

    <button id="Task-nextBtn" translate key="Start">Start</button>
</section>

<div id="EndTestModal" class="modal">

    <!-- Modal content -->
    <div class="modal-content">
        <div class="modal-header">
            <h2 translate key="end_the_test_">End the test?</h2>
        </div>
        <div class="modal-body">
            <p translate key="did_you_complete">Did you complete the task?</p>
            <p translate key="if_youre_not">If you’re not done yet, press ‘Cancel’ and then select the test tab on your browser (this is the tab that opened after you started the test)</p>
        </div>
        <div class="modal-footer">
           <button id="EndTestModal-cancel" translate key="CANCEL">CANCEL</button>
            <button id="EndTestModal-end" translate key="end_the_test">END THE TEST</button>
        </div>
    </div>

</div>

<script>
    if(!navigator.getDisplayMedia && !navigator.mediaDevices.getDisplayMedia) {
        var error = 'Your browser does NOT support the getDisplayMedia API.';
        alert(error);

        throw new Error(error);
    }


    /*------------------------- End Test Modal ---------------------------*/
    // Get the modal
    let modal = document.getElementById("EndTestModal");

    // Get the button that opens the modal
    let btn = document.getElementById("Task-nextBtn");

    let cancel = document.getElementById("EndTestModal-cancel");
    let end = document.getElementById("EndTestModal-end");

    // When the user clicks the button, open the modal
    btn.onclick = function() {
        if (localStorage.getItem("startTest") === "1") {
            window.open(localStorage.getItem("invitation"));
            //window.open("https://www.google.ca/");
            document.getElementById("Task-nextBtn").innerText = localStorage.getItem("language") === "english"? "END THE TEST": "TERMINER LE TEST";
            localStorage.setItem("startTest", "0");
        } else if (localStorage.getItem("startTest") === "0") {
            modal.style.display = "block";
        }
    };

    cancel.onclick = function() {
        modal.style.display = "none";
    };

    end.onclick = function() {
        modal.style.display = "none";
        localStorage.setItem("cameraEnd", (new Date().getTime()).toString());
        cameraRecorder.stopRecording(stopCameraRecordingCallback);

        localStorage.setItem("screenEnd", (new Date().getTime()).toString());
        screenRecorder.stopRecording(stopScreenRecordingCallback);

        GazeCloudAPI.StopEyeTracking();
        setTimeout( function () {
            let times = {
                cameraStart: localStorage.getItem("cameraStart"),
                cameraEnd: localStorage.getItem("cameraEnd"),
                screenStart: localStorage.getItem("screenStart"),
                screenEnd: localStorage.getItem("screenEnd"),
                CalibrationStart: localStorage.getItem("CalibrationStart"),
                CalibrationEnd: localStorage.getItem("CalibrationEnd")
            };
            localStorage.setItem("TIMESTAMPS_CONTENT", JSON.stringify(times));
            uploadFile(JSON.stringify(times), localStorage.getItem("HASH_NAME") + "TIMESTAMPS.json");
            localStorage.setItem("TIMESTAMPS_NAME", localStorage.getItem("HASH_NAME") + "TIMESTAMPS.json");
            gotoNextPage("Task", "End1");
        }, 200);
    };

    // When the user clicks anywhere outside of the modal, close it
    window.onclick = function(event) {
        if (event.target === modal) {
            modal.style.display = "none";
        }
    };


    function SendAnalysisAndParticipantRequests() {
        if (localStorage.getItem("finishUploading") === "false") {
            localStorage.setItem("finishUploading", "true");
            setTimeout( function () {
                AnalysisPostRequest();
            }, 1000);
        }
    }


    /*--------------------- Camera Recording ---------------------*/
    let cameraRecorder; // globally accessible
    let video = document.querySelector('video');
    let cameraProgressPercentage;
    let cameraSeekableBlob;

    function captureCamera(callback) {
        navigator.mediaDevices.getUserMedia({
                audio: true,
                video: {
                    width: { ideal: 640 },
                    height: { ideal: 480 }
                }
            }).then(function(camera) {
            callback(camera);
        }).catch(function(error) {
            alert('Unable to capture your camera. Please check console logs.');
            console.error(error);
        });
    }

    function stopCameraRecordingCallback() {
        //video.src = video.srcObject = null;
        //video.muted = true;
        //video.volume = 0;
        //video.src = URL.createObjectURL(recorder.getBlob());

        let name = localStorage.getItem("HASH_NAME") + "VIDEO.mp4";
        localStorage.setItem("VIDEO_NAME", name);


        getSeekableBlob(cameraRecorder.getBlob(), function(seekableBlob) {
            cameraRecorder.camera.stop();
            cameraRecorder.destroy();
            cameraRecorder = null;

            cameraSeekableBlob = seekableBlob;

            setTimeout( function () {
                uploadFile(seekableBlob, name).on('httpUploadProgress', function(progress) {
                    cameraProgressPercentage = Math.round(progress.loaded / progress.total * 100);
                    document.getElementById("CameraProgress").innerHTML = cameraProgressPercentage + "%";
                    document.getElementById("CameraProgress").style.width = cameraProgressPercentage + "%";
                    //console.log(cameraProgressPercentage);

                    if (screenProgressPercentage === 100 && cameraProgressPercentage === 100) {
                        localStorage.setItem("FinishVideoUploading", "True");
                        if (localStorage.getItem("AnalysisAndParticipantRequest") === "complete") {
                            SendAnalysisAndParticipantRequests();
                            document.getElementById("Upload").getElementsByClassName("title")[0].getElementsByTagName("h2")[0].innerHTML = "Thank you!";
                            document.getElementById("Upload").getElementsByClassName("content")[0].getElementsByTagName("p")[0].innerHTML = "All your test data has been sent.";
                            document.getElementById("Upload").getElementsByClassName("content")[0].getElementsByTagName("p")[0].style.color = "#2FCC71";
                            document.getElementById("Upload").getElementsByClassName("instructions")[0].style.display = 'none';
                            document.getElementById("Upload").getElementsByClassName("buttons")[0].style.display = 'none';
                            document.getElementById("Upload").getElementsByClassName("finishUploading")[0].style.display = 'block';
                        }
                    }
                });
            }, 100);
        });
    }

    document.getElementById('Instruction4-nextBtn').onclick = function() {
        captureCamera(function(camera) {
            video.muted = true;
            video.volume = 0;
            video.srcObject = camera;

            cameraRecorder = RecordRTC(camera, {
                mimeType: 'video/webm;codecs=h264',
                bitsPerSecond: 6000000,
                frameRate: {exact: 30 },
                getNativeBlob: true
            });

            cameraRecorder.startRecording();
            localStorage.setItem("cameraStart", (new Date().getTime()).toString());
            // release camera on stopRecording
            cameraRecorder.camera = camera;
            //gotoNextPage('Instruction4', 'Instruction5');
        });

        captureScreen(function(screen) {
            screenRecorder = RecordRTC(screen, {
                mimeType: 'video/webm;codecs=h264',
                bitsPerSecond: 6000000,
                frameRate: {exact: 30 },
                getNativeBlob: true
            });


            screenRecorder.startRecording();
            localStorage.setItem("screenStart", (new Date().getTime()).toString());
            // release screen on stopRecording
            screenRecorder.screen = screen;

            gotoNextPage('Instruction4', 'Instruction5');
            GazeCloudAPI.StartEyeTracking();
        });

    };






    /*--------------------- Screen Recording ---------------------*/
    let screenRecorder; // globally accessible
    let screenProgressPercentage;
    let screenSeekableBlob;

    function invokeGetDisplayMedia(success, error) {
        var displaymediastreamconstraints = {
            video: {
                displaySurface: 'monitor', // monitor, window, application, browser
                logicalSurface: true,
                cursor: 'always' // never, always, motion
            }
        };

        // above constraints are NOT supported YET
        // that's why overriding them
        displaymediastreamconstraints = {
            video: true
        };

        if(navigator.mediaDevices.getDisplayMedia) {
            navigator.mediaDevices.getDisplayMedia(displaymediastreamconstraints).then(success).catch(error);
        }
        else {
            navigator.getDisplayMedia(displaymediastreamconstraints).then(success).catch(error);
        }
    }

    function captureScreen(callback) {
        invokeGetDisplayMedia(function(screen) {
            addStreamStopListener(screen, function() {
                document.getElementById('EndTestModal-end').click();
            });
            callback(screen);
        }, function(error) {
            console.error(error);
            alert('Unable to capture your screen. Please check console logs.\n' + error);
        });
    }

    function stopScreenRecordingCallback() {
        let name = localStorage.getItem("HASH_NAME") + "SCREEN.mp4";
        localStorage.setItem("SCREEN_NAME", name);

        getSeekableBlob(screenRecorder.getBlob(), function(seekableBlob) {
            screenRecorder.screen.stop();
            screenRecorder.destroy();
            screenRecorder = null;

            screenSeekableBlob = seekableBlob;

            setTimeout( function () {
                uploadFile(seekableBlob, name).on('httpUploadProgress', function(progress) {
                    screenProgressPercentage = Math.round(progress.loaded / progress.total * 100);
                    document.getElementById("ScreenProgress").innerHTML =  screenProgressPercentage + "%";
                    document.getElementById("ScreenProgress").style.width =  screenProgressPercentage + "%";
                    //console.log(screenProgressPercentage);

                    if (screenProgressPercentage === 100 && cameraProgressPercentage === 100) {
                        localStorage.setItem("FinishVideoUploading", "True");
                        if (localStorage.getItem("AnalysisAndParticipantRequest") === "complete") {
                            SendAnalysisAndParticipantRequests();
                            document.getElementById("Upload").getElementsByClassName("title")[0].getElementsByTagName("h2")[0].innerHTML = "Thank you!";
                            document.getElementById("Upload").getElementsByClassName("content")[0].getElementsByTagName("p")[0].innerHTML = "All your test data has been sent.";
                            document.getElementById("Upload").getElementsByClassName("content")[0].getElementsByTagName("p")[0].style.color = "#2FCC71";
                            document.getElementById("Upload").getElementsByClassName("instructions")[0].style.display = 'none';
                            document.getElementById("Upload").getElementsByClassName("buttons")[0].style.display = 'none';
                            document.getElementById("Upload").getElementsByClassName("finishUploading")[0].style.display = 'block';
                        }

                    }
                });
            }, 100);
        });


    }

    function addStreamStopListener(stream, callback) {
        stream.addEventListener('ended', function() {
            callback();
            callback = function() {};
        }, false);
        stream.addEventListener('inactive', function() {
            callback();
            callback = function() {};
        }, false);
        stream.getTracks().forEach(function(track) {
            track.addEventListener('ended', function() {
                callback();
                callback = function() {};
            }, false);
            track.addEventListener('inactive', function() {
                callback();
                callback = function() {};
            }, false);
        });
    }




    /*--------------------- AWS Uploading ---------------------*/
    const s3 = new AWS.S3({
        accessKeyId: 'AKIAZ7C44YZFAHK26JHY',
        secretAccessKey: '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',
        maxRetries: 10
    });

    const options = {
        partSize: 10 * 1024 * 1024,
        // how many concurrent uploads
        queueSize: 5
    };

    function uploadFile(fileContent, fileName) {
        // Read content from the file
        // const fileContent = fs.readFileSync(fileName);


        // Setting up S3 upload parameters
        const params = {
            Metadata: {
                'projectId': localStorage.getItem('projectId'),
            },
            Bucket: 'cubego-video-test-bucket',
            Key: fileName, // File name you want to save as in S3
            Body: fileContent
        };

        // Uploading files to the bucket
        return s3.upload(params, options, function(err, data) {
            if (err) {
                console.log('There was an error uploading your file: ', err);
                document.getElementById("Upload").getElementsByClassName("buttons")[0].style.display = 'block';
            } else {
                console.log(`File uploaded successfully. ${data.Location}`);
            }
        });
    }
</script>

<section id="End1">
    <div class="title">
        <h2 translate key="we_will_now">We will now ask you to answer a few short questions. </h2>
    </div>

    <button id="End1-nextBtn" onclick="gotoNextPage('End1', 'Demographic')" translate key="NEXT">NEXT</button>
</section>

<section id="Demographic">
    <div class="title">
        <h2 translate key="tell_us_about">Tell us about yourself</h2>
    </div>

    <form class="INFOForm">
        <div class="input-field">
            <h4 translate key="gender">Gender</h4>
            <div class="choices">
                <input type="radio" name="gender" value="male"><span translate key="male">Male</span>
                <input type="radio" name="gender" value="female"><span translate key="female">Female</span>
                <input type="radio" name="gender" value="prefer-not-to-say"><span translate key="prefer_not_to_say">Prefer no to say</span>
            </div>
        </div>

        <div class="input-field">
            <h4>Age</h4>
            <label>
                <input name="Age" id="Demographic-age" type="text" placeholder="Age">
            </label>
        </div>

        <div class="input-field">
            <h4 translate key="location">Location</h4>
            <label>
                <input name="Country" id="Demographic-country" type="text" placeholder="Country">
            </label>
            <label>
                <input name="City" id="Demographic-city" type="text" placeholder="City">
            </label>
        </div>

        <div class="input-field">
            <h4 translate key="yearly_income">Yearly income (excluding taxes)</h4>
            <select id="Demographic-income">
                <option value="No Election" selected="selected" translate key="no_selection">No Selection</option>
                <option value="$1k - $24k">$1k - $24k</option>
                <option value="$25k - $49k">$25k - $49k</option>
                <option value="$50k - $74k">$50k - $74k</option>
                <option value="$75k +">$75k +</option>
                <option value="No Income" translate key="no_income">No Income</option>
            </select>

        </div>
    </form>

    <button id="Demographic-nextBtn" onclick="DemographicNextPage()" translate key="NEXT">Next</button>
</section>

<section id="PostTestQuestion">
    <div class="title">
        <h2 translate key="please_answer_the">Please answer the question below</h2>
    </div>

    <div class="question">
        <p class="question-text"></p>
        <div class="radioGroup">
            <div class="radioButtons">
                <div class="wrap">
                    <label>0</label>
                    <input type="radio" name="rate" value="0" />
                </div>
                <div class="wrap">
                    <label>1</label>
                    <input type="radio" name="rate" value="1" />
                </div>
                <div class="wrap">
                    <label>2</label>
                    <input type="radio" name="rate" value="2" />
                </div>
                <div class="wrap">
                    <label>3</label>
                    <input type="radio" name="rate" value="3" />
                </div>
                <div class="wrap">
                    <label>4</label>
                    <input type="radio" name="rate" value="4" />
                </div>
                <div class="wrap">
                    <label>5</label>
                    <input type="radio" name="rate" value="5" />
                </div>
                <div class="wrap">
                    <label>6</label>
                    <input type="radio" name="rate" value="6" />
                </div>
                <div class="wrap">
                    <label>7</label>
                    <input type="radio" name="rate" value="7" />
                </div>
                <div class="wrap">
                    <label>8</label>
                    <input type="radio" name="rate" value="8" />
                </div>
                <div class="wrap">
                    <label>9</label>
                    <input type="radio" name="rate" value="9" />
                </div>
                <div class="wrap">
                    <label>10</label>
                    <input type="radio" name="rate" value="10" />
                </div>
            </div>
            <p class="left-text" translate key="extremely_unlikely">Extremely Unlikely</p>
            <p class="right-text" translate key="extremely_likely">Extremely Likely</p>
        </div>
    </div>

    <button id="PostTestQuestion-nextBtn" onclick="PostTestQuestionNextPage()" translate key="NEXT">NEXT</button>
</section>

<section id="SEQQuestion">
    <div class="title">
        <h2 translate key="please_answer_the">Please answer the question below</h2>
    </div>

    <div class="question">
        <p class="question-text" translate key="overall_this_task">Overall, this task was?</p>
        <div class="radioGroup">
            <div class="radioButtons">
                <div class="wrap">
                    <label>1</label>
                    <input type="radio" name="rate" value="1" />
                </div>
                <div class="wrap">
                    <label>2</label>
                    <input type="radio" name="rate" value="2" />
                </div>
                <div class="wrap">
                    <label>3</label>
                    <input type="radio" name="rate" value="3" />
                </div>
                <div class="wrap">
                    <label>4</label>
                    <input type="radio" name="rate" value="4" />
                </div>
                <div class="wrap">
                    <label>5</label>
                    <input type="radio" name="rate" value="5" />
                </div>
                <div class="wrap">
                    <label>6</label>
                    <input type="radio" name="rate" value="6" />
                </div>
                <div class="wrap">
                    <label>7</label>
                    <input type="radio" name="rate" value="7" />
                </div>
            </div>
            <p class="left-text" translate key="very_difficult">Very Difficult</p>
            <p class="right-text" translate key="very_easy">Very Easy</p>
        </div>
    </div>

    <button id="SEQQuestion-nextBtn" onclick="SEQQuestionNextPage()" translate key="NEXT">NEXT</button>
</section>

<section id="SUSQuestion">
    <div class="title">
        <h2 translate key="please_answer_the">Please answer the questions below</h2>
    </div>

    <div class="question1">
        <p class="question">I think that I would like to use this website frequently.</p>
        <div class="radioGroup">
            <div class="radioButtons">
                <div class="wrap">
                    <label>1</label>
                    <input type="radio" name="rate1" value="1" />
                </div>
                <div class="wrap">
                    <label>2</label>
                    <input type="radio" name="rate1" value="2" />
                </div>
                <div class="wrap">
                    <label>3</label>
                    <input type="radio" name="rate1" value="3" />
                </div>
                <div class="wrap">
                    <label>4</label>
                    <input type="radio" name="rate1" value="4" />
                </div>
                <div class="wrap">
                    <label>5</label>
                    <input type="radio" name="rate1" value="5" />
                </div>
            </div>
            <p class="left-text">Strongly Disagree</p>
            <p class="right-text">Strongly Agree</p>
        </div>
    </div>

    <div class="question2">
        <p class="question">I found the website unnecessarily complex.</p>
        <div class="radioGroup">
            <div class="radioButtons">
                <div class="wrap">
                    <label>1</label>
                    <input type="radio" name="rate2" value="1" />
                </div>
                <div class="wrap">
                    <label>2</label>
                    <input type="radio" name="rate2" value="2" />
                </div>
                <div class="wrap">
                    <label>3</label>
                    <input type="radio" name="rate2" value="3" />
                </div>
                <div class="wrap">
                    <label>4</label>
                    <input type="radio" name="rate2" value="4" />
                </div>
                <div class="wrap">
                    <label>5</label>
                    <input type="radio" name="rate2" value="5" />
                </div>
            </div>
            <p class="left-text">Strongly Disagree</p>
            <p class="right-text">Strongly Agree</p>
        </div>
    </div>

    <div class="question3">
        <p class="question">I thought the website was easy to use.</p>
        <div class="radioGroup">
            <div class="radioButtons">
                <div class="wrap">
                    <label>1</label>
                    <input type="radio" name="rate3" value="1" />
                </div>
                <div class="wrap">
                    <label>2</label>
                    <input type="radio" name="rate3" value="2" />
                </div>
                <div class="wrap">
                    <label>3</label>
                    <input type="radio" name="rate3" value="3" />
                </div>
                <div class="wrap">
                    <label>4</label>
                    <input type="radio" name="rate3" value="4" />
                </div>
                <div class="wrap">
                    <label>5</label>
                    <input type="radio" name="rate3" value="5" />
                </div>
            </div>
            <p class="left-text">Strongly Disagree</p>
            <p class="right-text">Strongly Agree</p>
        </div>
    </div>

    <div class="question4">
        <p class="question">I think that I would need the support of a technical person to be able to use this website.</p>
        <div class="radioGroup">
            <div class="radioButtons">
                <div class="wrap">
                    <label>1</label>
                    <input type="radio" name="rate4" value="1" />
                </div>
                <div class="wrap">
                    <label>2</label>
                    <input type="radio" name="rate4" value="2" />
                </div>
                <div class="wrap">
                    <label>3</label>
                    <input type="radio" name="rate4" value="3" />
                </div>
                <div class="wrap">
                    <label>4</label>
                    <input type="radio" name="rate4" value="4" />
                </div>
                <div class="wrap">
                    <label>5</label>
                    <input type="radio" name="rate4" value="5" />
                </div>
            </div>
            <p class="left-text">Strongly Disagree</p>
            <p class="right-text">Strongly Agree</p>
        </div>
    </div>

    <div class="question5">
        <p class="question">I found the various functions of this website were well integrated.</p>
        <div class="radioGroup">
            <div class="radioButtons">
                <div class="wrap">
                    <label>1</label>
                    <input type="radio" name="rate5" value="1" />
                </div>
                <div class="wrap">
                    <label>2</label>
                    <input type="radio" name="rate5" value="2" />
                </div>
                <div class="wrap">
                    <label>3</label>
                    <input type="radio" name="rate5" value="3" />
                </div>
                <div class="wrap">
                    <label>4</label>
                    <input type="radio" name="rate5" value="4" />
                </div>
                <div class="wrap">
                    <label>5</label>
                    <input type="radio" name="rate5" value="5" />
                </div>
            </div>
            <p class="left-text">Strongly Disagree</p>
            <p class="right-text">Strongly Agree</p>
        </div>
    </div>

    <div class="question6">
        <p class="question">I thought there was too much inconsistency in this website.</p>
        <div class="radioGroup">
            <div class="radioButtons">
                <div class="wrap">
                    <label>1</label>
                    <input type="radio" name="rate6" value="1" />
                </div>
                <div class="wrap">
                    <label>2</label>
                    <input type="radio" name="rate6" value="2" />
                </div>
                <div class="wrap">
                    <label>3</label>
                    <input type="radio" name="rate6" value="3" />
                </div>
                <div class="wrap">
                    <label>4</label>
                    <input type="radio" name="rate6" value="4" />
                </div>
                <div class="wrap">
                    <label>5</label>
                    <input type="radio" name="rate6" value="5" />
                </div>
            </div>
            <p class="left-text">Strongly Disagree</p>
            <p class="right-text">Strongly Agree</p>
        </div>
    </div>

    <div class="question7">
        <p class="question">I would imagine that most people would learn to used this website very quickly.</p>
        <div class="radioGroup">
            <div class="radioButtons">
                <div class="wrap">
                    <label>1</label>
                    <input type="radio" name="rate7" value="1" />
                </div>
                <div class="wrap">
                    <label>2</label>
                    <input type="radio" name="rate7" value="2" />
                </div>
                <div class="wrap">
                    <label>3</label>
                    <input type="radio" name="rate7" value="3" />
                </div>
                <div class="wrap">
                    <label>4</label>
                    <input type="radio" name="rate7" value="4" />
                </div>
                <div class="wrap">
                    <label>5</label>
                    <input type="radio" name="rate7" value="5" />
                </div>
            </div>
            <p class="left-text">Strongly Disagree</p>
            <p class="right-text">Strongly Agree</p>
        </div>
    </div>

    <div class="question8">
        <p class="question">I found the website vert awkward to use.</p>
        <div class="radioGroup">
            <div class="radioButtons">
                <div class="wrap">
                    <label>1</label>
                    <input type="radio" name="rate8" value="1" />
                </div>
                <div class="wrap">
                    <label>2</label>
                    <input type="radio" name="rate8" value="2" />
                </div>
                <div class="wrap">
                    <label>3</label>
                    <input type="radio" name="rate8" value="3" />
                </div>
                <div class="wrap">
                    <label>4</label>
                    <input type="radio" name="rate8" value="4" />
                </div>
                <div class="wrap">
                    <label>5</label>
                    <input type="radio" name="rate8" value="5" />
                </div>
            </div>
            <p class="left-text">Strongly Disagree</p>
            <p class="right-text">Strongly Agree</p>
        </div>
    </div>

    <div class="question9">
        <p class="question">I felt very confident using this website.</p>
        <div class="radioGroup">
            <div class="radioButtons">
                <div class="wrap">
                    <label>1</label>
                    <input type="radio" name="rate9" value="1" />
                </div>
                <div class="wrap">
                    <label>2</label>
                    <input type="radio" name="rate9" value="2" />
                </div>
                <div class="wrap">
                    <label>3</label>
                    <input type="radio" name="rate9" value="3" />
                </div>
                <div class="wrap">
                    <label>4</label>
                    <input type="radio" name="rate9" value="4" />
                </div>
                <div class="wrap">
                    <label>5</label>
                    <input type="radio" name="rate9" value="5" />
                </div>
            </div>
            <p class="left-text">Strongly Disagree</p>
            <p class="right-text">Strongly Agree</p>
        </div>
    </div>

    <div class="question10">
        <p class="question">I needed to learn a lot of things before I could get going with this website.</p>
        <div class="radioGroup">
            <div class="radioButtons">
                <div class="wrap">
                    <label>1</label>
                    <input type="radio" name="rate10" value="1" />
                </div>
                <div class="wrap">
                    <label>2</label>
                    <input type="radio" name="rate10" value="2" />
                </div>
                <div class="wrap">
                    <label>3</label>
                    <input type="radio" name="rate10" value="3" />
                </div>
                <div class="wrap">
                    <label>4</label>
                    <input type="radio" name="rate10" value="4" />
                </div>
                <div class="wrap">
                    <label>5</label>
                    <input type="radio" name="rate10" value="5" />
                </div>
            </div>
            <p class="left-text">Strongly Disagree</p>
            <p class="right-text">Strongly Agree</p>
        </div>
    </div>

    <button id="SUSQuestion-nextBtn" onclick="SUSQuestionNextPage()">Next</button>
</section>

<section id="NASAQuestion">
    <div class="title">
        <h2>Please answer the questions below</h2>
    </div>

    <div class="question1">
        <p class="question">How mentally demanding was the task?</p>
        <div class="slider-area">
            <div class="slider"></div>
            <p class="left-text">Not at all<br>Demanding</p>
            <p class="right-text">Extremely<br>Demanding</p>
        </div>
    </div>

    <div class="question2">
        <p class="question">How hurried or rushed was the pace of the task?</p>
        <div class="slider-area">
            <div class="slider"></div>
            <p class="left-text">Not at all<br>Rushed</p>
            <p class="right-text">Extremely<br>Rushed</p>
        </div>
    </div>

    <div class="question3">
        <p class="question">How successful were you in accomplishing what you were asked to do?</p>
        <div class="slider-area">
            <div class="slider"></div>
            <p class="left-text">Extremely<br>Unsuccessful</p>
            <p class="right-text">Extremely<br>Successful</p>
        </div>
    </div>

    <div class="question4">
        <p class="question">How hard did you have to work to accomplish your level of performance?</p>
        <div class="slider-area">
            <div class="slider"></div>
            <p class="left-text">Not at all<br>Hard</p>
            <p class="right-text">Extremely<br>Hard</p>
        </div>
    </div>
    <button id="NASAQuestion-nextBtn" onclick="NASAQuestionNextPage()">Next</button>
</section>

<script>
    $(".slider")

        .slider({
            min: 0,
            max: 10,
            step: 0.5
        })

        .slider("pips", {
            rest: "label",
            step: 2
        })

        .slider("float");

    $("#NASAQuestion .question1 .slider").on("slidechange", function(k, v) {
        localStorage.setItem("nasaMental", v['value']);
    });
    $("#NASAQuestion .question2 .slider").on("slidechange", function(k, v) {
        localStorage.setItem("nasaPerformance", v['value']);
    });
    $("#NASAQuestion .question3 .slider").on("slidechange", function(k, v) {
        localStorage.setItem("nasaTemporal", v['value']);
    });
    $("#NASAQuestion .question4 .slider").on("slidechange", function(k, v) {
        localStorage.setItem("nasaEffort", v['value']);
    });
</script>

<section id="PostCustomQuestions">
    <div class="title">
        <h2 translate key="custom_questions">Custom Questions</h2>
    </div>

    <button id="PostCustomQuestions-nextBtn" onclick="PostCustomQuestionsNextPage('PostCustomQuestions', 'CommentQuestion')" translate key="NEXT">Next</button>
</section>

<section id="CommentQuestion">
    <div class="title">
        <h2 translate key="the_test_has_ended">The test has ended.</h2>
    </div>

    <div class="content">
        <p translate key="did_you_experience">Did you experience any difficulties with this test?</p>
        <textarea name="comment" id="CommentQuestion-comment" cols="60" rows="15" placeholder="Let us know if you encountered any bugs, if the instructions were unclear, or if something went wrong."></textarea>
    </div>

    <button id="CommentQuestion-nextBtn" onclick="CommentQuestionNextPage('CommentQuestion', 'Upload')" translate key="NEXT">Next</button>
</section>

<section id="Upload">
    <div class="title">
        <h2 translate key="give_us_a_second">Give us a second...</h2>
    </div>

    <div class="content">
        <p translate key="please_wait_while_we">Please wait while we upload your test files.</p>
        <div class="progress1">
            <label for="ScreenProgress" translate key="screen_recording_progress">Screen Recording progress:</label>
            <div class="progressBar">
                <div id="ScreenProgress">0%</div>
            </div>
        </div>
        <div class="progress2">
            <label for="CameraProgress" translate key="camera_recording_progress">Camera Recording progress:</label>
            <div class="progressBar">
                <div id="CameraProgress">0%</div>
            </div>
        </div>
    </div>

    <div class="instructions">
        <p translate key="please_do_not">Please <b>do not</b> close your browser window before the upload is done.</p>
        <p translate key="doing_so_may">Doing so may lead to losing your test data, and not receiving payment for this test.</p>
        <p translate key="if_the_videos">If the videos are not uploading correctly,  please download the files onto your computer and then upload them to the following link:</p>
        <a href="https://www.dropbox.com/request/l7TKYa765jKyPFCkaF1W" target="_blank">https://www.dropbox.com/request/l7TKYa765jKyPFCkaF1W</a>
    </div>

    <div class="buttons">
<!--        <button id="Upload-redo" onclick="reUploadVideos()">Re-Upload Videos</button>-->
        <button id="Upload-download" onclick="downloadVideos()" translate key="download_videos">Download Videos</button>
    </div>
    <div class="finishUploading">
        <p translate key="you_may_now_close">You may now close your browser window or tab.</p>
    </div>
</section>

<script>
    //things that do when page loads
    window.onload = function () {
        localStorage.clear();
        localStorage.setItem("currentPage", "StartPage");
        localStorage.setItem("startTest", "1");
        localStorage.setItem("finishUploading", "false");
        localStorage.setItem("language", "english");

        let w = screen.width;
        let h = screen.height;
        let DPR = window.devicePixelRatio;
        w = Math.round(DPR * w);
        h = Math.round(DPR * h);
        document.documentElement.style.fontSize = 10 * (w / 1920) + 'px';

        if (window.devicePixelRatio === 2) {
            window.parent.document.body.style.zoom = '0.5';
        } else {
            window.parent.document.body.style.zoom = '1';
        }
    };
</script>


<script src="js/Language-List.js"></script>
<script src="js/Language.js"></script>

</body>
</html>
